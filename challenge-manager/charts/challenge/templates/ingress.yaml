{{- range $container := .Values.containers }}
{{- range $port := $container.ports }}
---
apiVersion: traefik.io/v1alpha1
{{- if eq $port.protocol "http" }}
kind: IngressRoute
{{- else }}
kind: IngressRouteTCP
{{- end }}
metadata:
  {{- $name := join "-" (compact (list $.Release.Name $container.name (default "" $port.domain)))}}
  name: {{ $name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    "kube-ctf.io/instance": {{ $.Release.Name }}-{{ $container.name }}
    {{- range $key, $value := $.Values.labels }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
spec:
  routes:
    {{- $subdomain := join "-" (compact (list (default "" $port.domain) (default "" $container.name))) }}
    {{- $match := (ternary "Host" "HostSNI" (eq $port.protocol "http")) }}
    - match: {{ $match }}(`{{ $subdomain }}.{{ $.Values.global.baseDomain }}`)
      {{- if eq $port.protocol "http" }}
      kind: Rule
      {{- end }}
      services:
        - name: {{ $.Release.Name }}-{{ $container.name }}
          port: {{ $port.number }}
  tls:
    secretName: {{ $.Values.global.tlsCert }}
{{- end }}
{{- end }}
